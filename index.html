<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="style.css" />
        <title>Kalimba Song Composer</title>
    </head>

    <body>
        <h1>Kalimba Song Composer</h1>
        <form id="upload-song">
            <label>upload song: <input type="file" name="upload" /></label>
            <button type="submit">upload</button>
        </form>
        <div id="song-display"></div>
        <form id="kalimba"></form>
        <div id="process-buttons" style="display: none">
            <button id="write-file-button">write to file</button>
            <button id="clear-song-button">clear song</button>
        </div>

        <script type="module">
            import Line from "./classes/Line.js";
            import Song from "./classes/Song.js";
            import {
                allNotes,
                getSelectNoteLengthHTML,
            } from "./kalimba-data.js";

            let song = new Song();
            const uploadSong = document.querySelector("#upload-song"),
                songDisplayElem = document.querySelector("#song-display"),
                processButtons = document.querySelector("#process-buttons"),
                writeFileButton = document.querySelector("#write-file-button"),
                clearSongButton = document.querySelector("#clear-song-button");

            uploadSong.onsubmit = (e) => {
                e.preventDefault();
                const fr = new FileReader(),
                    file = e.target.upload.files[0];
                fr.addEventListener(
                    "load",
                    () => {
                        // this will then display a text file
                        song = new Song(fr.result);
                        updateSong();
                    },
                    false
                );
                fr.readAsText(file);
                processButtons.style.display = "block";
            };

            writeFileButton.onclick = () => song.writeFile();

            clearSongButton.onclick = () => {
                song = new Song();
                updateSong();
                processButtons.style.display = "none";
            };

            updateSong();

            function updateSong() {
                const header = `
                    <div class="line">
                        ${["", ...allNotes]
                            .map(
                                (note) => `
                                    <div class="note-container">
                                        <span>
                                            ${note[0] || ""}
                                            <br/>
                                            ${
                                                note
                                                    ?.slice(1)
                                                    .replace("*", "") || ""
                                            }
                                            <br/>
                                            ${
                                                note.includes("*")
                                                    ? "&bull;"
                                                    : "&nbsp;"
                                            }
                                        </span>
                                    </div>
                                `
                            )
                            .join("")}
                    </div>`,
                    lines = song
                        .getLines()
                        .map((line) => line.getLineHTML())
                        .join(""),
                    form = `
                        <form id="add-line">
                            <div class="line">
                                ${["", ...allNotes]
                                    .map(
                                        (note, i) => `
                                            <div class="note-container">
                                                ${
                                                    i
                                                        ? `<input type="checkbox" name="${note}" />`
                                                        : `<button type="submit">+</button>`
                                                }
                                            </div>
                                        `
                                    )
                                    .join("")}
                            </div>
                            <div style="text-align: center">
                                <label>note: ${getSelectNoteLengthHTML()}</label>
                            </div>
                        </form>`;
                songDisplayElem.innerHTML = header + lines + form;
                document.querySelector("#add-line").onsubmit = (e) => {
                    e.preventDefault();
                    const formData = new Map(
                        [...new FormData(e.target).entries()]
                            .filter(([key]) => key !== "note-length")
                            .map(([key]) => [
                                key,
                                e.target["note-length"].value,
                            ])
                    );
                    song.addLine(new Line(formData));
                    updateSong();
                    processButtons.style.display = "block";
                };
            }
        </script>
    </body>
</html>
